<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Map</title>
    <style>
        /* Added CSS to make the button bigger */
        button {
            font-size: 1.5em;
            padding: 10px 20px;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap" async defer></script>
    <script>
        let map;
        let marker;
        let circle;
        let originalPosition;
        let initialPosition;

        function initMap(terrainSize, originalLat, originalLng) {

            originalPosition = {
                lat: originalLat,
                lng: originalLng
            };

            function createMap(centerPosition) {
                return new google.maps.Map(document.getElementById('map'), {
                    center: centerPosition,
                    zoom: 14
                });
            }

            function createMarker(map, position) {
                return new google.maps.Marker({
                    position: position,
                    map: map,
                    draggable: true
                });
            }

            function createCircle(map, centerPosition, radius) {
                return new google.maps.Circle({
                    map: map,
                    center: centerPosition,
                    radius: radius,
                    editable: false,
                    draggable: false
                });
            }

            function setupMapAndMarker(centerPosition) {
                map = createMap(centerPosition);
                marker = createMarker(map, centerPosition);
                circle = createCircle(map, centerPosition, terrainSize);

                google.maps.event.addListener(map, 'click', function (event) {
                    changeMarker(event.latLng);
                });

                google.maps.event.addListener(marker, 'dragend', function () {
                    changeMarker(marker.getPosition());
                });
            }

             function handleLocationError(hasGeolocation, fallbackPosition) {
                map = createMap(fallbackPosition);
                marker = createMarker(map, fallbackPosition);

                google.maps.event.addListener(map, 'click', function (event) {
                    changeMarker(event.latLng);
                });

                 google.maps.event.addListener(marker, 'dragend', function () {
                    changeMarker(marker.getPosition());
                });
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    initialPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    setupMapAndMarker(initialPosition);
                    getSelectedPosition();
                }, function () {
                        handleLocationError(true, map.getCenter());
                    });
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, map.getCenter());
            }
        }


         function updateRadius(newRadius) {
            // Check if the circle and marker exist
            if (circle && marker) {
                // Update the radius of the circle
                circle.setRadius(newRadius);

                // Optionally, you can update the circle's center to match the marker's position
                circle.setCenter(marker.getPosition());
            } else {
                console.error("Circle or marker not found.");
            }
        }

        function getSelectedPosition() {
            // Send the selected position to Unity
            Unity.call(marker.position.lat() + ',' + marker.position.lng());
        }

        function changeMarker(location) {
            marker.setPosition(location);

            map.setCenter(location);

            circle.setCenter(marker.getPosition());
            getSelectedPosition();
        }

    </script>
</head>

<body>
    <div id="map" style="height: 100vh;"></div>

    <!-- Added button to execute getSelectedPosition() function -->
    <button onclick="changeMarker(initialPosition)">User Position</button>
    <button onclick="changeMarker(originalPosition)">Terrain Original Position</button>
    <button onclick="Unity.call('Proyect')">Proyect Terrain</button>
</body>

</html>
