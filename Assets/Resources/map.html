<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Map</title>
    <style>
        .custom-button {
        font-size: 1em;
        padding: 10px 20px;
        margin: 5px;
        border: none;
        cursor: pointer;
        border-radius: 5px;
    }

    .red-button {
        background-color: red;
        color: white;
        float: left;
    }

    .blue-button {
        background-color: blue;
        color: white;
        float: center;
    }

    .green-button {
        background-color: green;
        color: white;
        float: right;
    }

     /* Added CSS to make the button bigger */
    button {
        font-size: 1.5em;
        padding: 10px 20px;
    }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap" async defer></script>
    <script>
        let map;
        let marker;
        let circle;
        let originalPosition;
        let initialPosition;
        let isProyecting;

        function initMap(terrainSize, originalLat, originalLng, isProyection) {

            isProyecting = isProyection;

            originalPosition = {
                lat: originalLat,
                lng: originalLng
            };

            function createMap(centerPosition) {
                return new google.maps.Map(document.getElementById('map'), {
                    center: centerPosition,
                    zoom: 12
                });
            }

            function createMarker(map, position) {
                return new google.maps.Marker({
                    position: position,
                    map: map,
                    draggable: true
                });
            }

            function createCircle(map, centerPosition, radius) {
                return new google.maps.Circle({
                    map: map,
                    center: centerPosition,
                    radius: radius,
                    editable: false,
                    draggable: false
                });
            }

            function setupMapAndMarker(centerPosition) {
                map = createMap(centerPosition);
                marker = createMarker(map, centerPosition);
                circle = createCircle(map, centerPosition, terrainSize);

                google.maps.event.addListener(map, 'click', function (event) {
                    changeMarker(event.latLng);
                });

                google.maps.event.addListener(marker, 'dragend', function () {
                    changeMarker(marker.getPosition());
                });
            }

             function handleLocationError(hasGeolocation, fallbackPosition) {
                map = createMap(fallbackPosition);
                marker = createMarker(map, fallbackPosition);

                google.maps.event.addListener(map, 'click', function (event) {
                    changeMarker(event.latLng);
                });

                 google.maps.event.addListener(marker, 'dragend', function () {
                    changeMarker(marker.getPosition());
                });
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    initialPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    setupMapAndMarker(initialPosition);
                    getSelectedPosition();
                    createButtons();
                }, function () {
                        handleLocationError(true, map.getCenter());
                    });
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, map.getCenter());
                createButtons();
            }
        }


         function updateRadius(newRadius) {
            // Check if the circle and marker exist
            if (circle && marker) {
                // Update the radius of the circle
                circle.setRadius(newRadius);

                // Optionally, you can update the circle's center to match the marker's position
                circle.setCenter(marker.getPosition());
            } else {
                console.error("Circle or marker not found.");
            }
        }

        function getSelectedPosition() {
            // Send the selected position to Unity
            Unity.call(marker.position.lat() + ',' + marker.position.lng());
        }

        function changeMarker(location) {
            marker.setPosition(location);

            map.setCenter(location);

            circle.setCenter(marker.getPosition());
            getSelectedPosition();
        }

        function createButtons() {
             // Remove existing buttons with the specified class
            document.querySelectorAll(".custom-button").forEach(button => {
                button.parentNode.removeChild(button);
            });

            if (isProyecting) {
                const backButton = createButton("Back", "red-button", function () {
                    Unity.call('Back');
                });
                document.body.appendChild(backButton);

                const userPositionButton = createButton("User Position", "blue-button", function () {
                    changeMarker(initialPosition);
                });
                document.body.appendChild(userPositionButton);

                const terrainOriginalPositionButton = createButton("Terrain Original Position", "blue-button", function () {
                    changeMarker(originalPosition);
                });
                document.body.appendChild(terrainOriginalPositionButton);

                const proyectTerrainButton = createButton("Proyect Terrain", "green-button", function () {
                    Unity.call('Proyect');
                });
                document.body.appendChild(proyectTerrainButton);

                // Set the height of the map based on isProyecting
                document.getElementById('map').style.height = '85vh';
            } else {
                // Set the height of the map based on isProyecting
                document.getElementById('map').style.height = '100vh';
            }

            function createButton(text, className, onClickHandler) {
                const button = document.createElement("button");
                button.textContent = text;
                button.className = "custom-button " + className; // Add custom-button class and specific className
                button.onclick = onClickHandler;
                return button;
            }
        }
    </script>

    </script>
</head>

<body>
    <div id="map"></div>
</body>

</html>
