<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Map</title>
    <style>
        /* Added CSS to make the button bigger */
        button {
            font-size: 1.5em;
            padding: 10px 20px;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap" async defer></script>
    <script>
        let map;
        let marker;
        let circle;
        let originalPosition;
        let initialPosition;
        let isProyecting;

        function initMap(terrainSize, originalLat, originalLng, isProyection) {

            isProyecting = isProyection;

            originalPosition = {
                lat: originalLat,
                lng: originalLng
            };

            function createMap(centerPosition) {
                return new google.maps.Map(document.getElementById('map'), {
                    center: centerPosition,
                    zoom: 12
                });
            }

            function createMarker(map, position) {
                return new google.maps.Marker({
                    position: position,
                    map: map,
                    draggable: true
                });
            }

            function createCircle(map, centerPosition, radius) {
                return new google.maps.Circle({
                    map: map,
                    center: centerPosition,
                    radius: radius,
                    editable: false,
                    draggable: false
                });
            }

            function setupMapAndMarker(centerPosition) {
                map = createMap(centerPosition);
                marker = createMarker(map, centerPosition);
                circle = createCircle(map, centerPosition, terrainSize);

                google.maps.event.addListener(map, 'click', function (event) {
                    changeMarker(event.latLng);
                });

                google.maps.event.addListener(marker, 'dragend', function () {
                    changeMarker(marker.getPosition());
                });
            }

             function handleLocationError(hasGeolocation, fallbackPosition) {
                map = createMap(fallbackPosition);
                marker = createMarker(map, fallbackPosition);

                google.maps.event.addListener(map, 'click', function (event) {
                    changeMarker(event.latLng);
                });

                 google.maps.event.addListener(marker, 'dragend', function () {
                    changeMarker(marker.getPosition());
                });
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    initialPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    setupMapAndMarker(initialPosition);
                    getSelectedPosition();
                    createButtons();
                }, function () {
                        handleLocationError(true, map.getCenter());
                    });
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, map.getCenter());
                createButtons();
            }
        }


         function updateRadius(newRadius) {
            // Check if the circle and marker exist
            if (circle && marker) {
                // Update the radius of the circle
                circle.setRadius(newRadius);

                // Optionally, you can update the circle's center to match the marker's position
                circle.setCenter(marker.getPosition());
            } else {
                console.error("Circle or marker not found.");
            }
        }

        function getSelectedPosition() {
            // Send the selected position to Unity
            Unity.call(marker.position.lat() + ',' + marker.position.lng());
        }

        function changeMarker(location) {
            marker.setPosition(location);

            map.setCenter(location);

            circle.setCenter(marker.getPosition());
            getSelectedPosition();
        }

        function createButtons() {
            if (isProyecting) {
                // Create and append buttons only if isProyecting is false
                const userPositionButton = document.createElement("button");
                userPositionButton.textContent = "User Position";
                userPositionButton.onclick = function () {
                    changeMarker(initialPosition);
                };
                document.body.appendChild(userPositionButton);

                const terrainOriginalPositionButton = document.createElement("button");
                terrainOriginalPositionButton.textContent = "Terrain Original Position";
                terrainOriginalPositionButton.onclick = function () {
                    changeMarker(originalPosition);
                };
                document.body.appendChild(terrainOriginalPositionButton);

                const proyectTerrainButton = document.createElement("button");
                proyectTerrainButton.textContent = "Proyect Terrain";
                proyectTerrainButton.onclick = function () {
                    Unity.call('Proyect');
                };
                document.body.appendChild(proyectTerrainButton);
            
                // Set the height of the map based on isProyecting
                document.getElementById('map').style.height = '85vh';
            } else {
                // Set the height of the map based on isProyecting
                document.getElementById('map').style.height = '100vh';
            }
        }
    </script>

    </script>
</head>

<body>
    <div id="map"></div>
</body>

</html>
